## Моторизированная тележка управляемая по ИК от стандартного пульта ДУ
### Модуль цифровой схемы для управления движением тележки (control)

Этот модуль, основываясь на декодированных команд с пульта ДУ, посылает управляющие сигналы на электродвигатель и сервопривод.
Модуль спроектирован для работы на плате ["Карно"](https://github.com/Fabmicro-LLC/Karnix_ASB-254), на базе ПЛИС Lattice ECP5.

### Входные параметры:
* clk_hz - частота тактового сигнала ПЛИС (по умолчанию 25МГц);
* sclk_hz - частота работы модуля (по умолчанию 256 Гц);
* servo_min - минимальный коэффициент заполнения PDM для сервопривода (0-255, соответствует крайнему правому положению колес);
* servo_max - максимальный коэффициент заполнения PDM для сервопривода (0-255, соответствует крайнему левому положению колес);
* servo_step - изменение коэффициента заполнения PDM за одно нажатие кнопки (по умолчанию 32);
* servo_center - центральное положение колес, получается при нажатии кнопки сброса 0 (по умолчанию 155);
* motor_min - минимальный коэффициент заполнения PWM для электродвигателя (0-255, соответствует минимальной скорости);
* motor_max - максимальный коэффициент заполнения PWM для электродвигателя (0-255, соответствует максимальной скорости);
* motor_step - изменения коэффициента заполнения PWM за одно нажатие кнопки (по умолчанию 32).

### Входные сигналы:
* clk - тактовая частота;
* rst - сигнал сброса;
* ir_ready - сигнал готовности модуля IRDecoder передавать данные;
* can_move_fwd - сигнал, сигнализирующий о возможности движения вперед (впереди нет препятствия).
* command (32-bit) - декодированная команда;

### Выходные сигналы:
* state - сигнал, сигнализирующий о состоянии тележки (вкл/выкл);
* ctl_valid - сигнал готовности модуля Control принимать данные;
* ack - сигнал завершения обработки команды;
* direction - сигнал направления движения (1 - вперед, 0 - назад);
* motor_dc (8-bit) - коэффициент заполнения PWM электродвигателя;
* servo_dc (8-bit) - коэффициент заполнения PDM сервопривода.

### Список команд:
Ниже представлен список команд, которые обрабатывает модуль:

| № команды |Кнопка на пульте  | 32-битный код | Описание                       | Управляющее воздействие                 |
| :-------: | :--------------: | :-----------: | :----------------------------: | :-------------------------------------: |
| 1         | Add              | 0x6897FF00    | Включение системы              | `state <= 1'd1`                         |
| 2         | ON/OFF           | 0x7788FF00    | Выключение системы             | `state <= 1'd0`                         |
| 3         | Up               | 0x6A95FF00    | Установка направления вперед   | `direction <= 1'd1`                     |
| 4         | Down             | 0x659AFF00    | Установка направления назад    | `direction <= 1'd0`                     |
| 5         | Left             | 0x649BFF00    | Поворот серво влево            | `servo_dc <= servo_dc + 8'(servo_step)` |
| 6         | Right            | 0x6699FF00    | Поворот серво вправо           | `servo_dc <= servo_dc - 8'(servo_step)` |
| 7         | Focus +          | 0x7C83FF00    | Увеличение скорости двигателя  | `motor_dc <= motor_dc + 8'(motor_step)` |
| 8         | Focus -          | 0x6F90FF00    | Уменьшение скорости двигателя  | `motor_dc <= motor_dc - 8'(motor_step)` |
| 9         | Enter            | 0x619EFF00    | Останов                        | `motor_dc <= 8'd0`                      |
| 10        | 0                | 0x6D92FF00    | Сброс серво в нейтраль         | `servo_dc <= 8'(servo_center)`          |

### Запуск на ОС Linux:
1. Установить инструментарий: [YosysHQ](https://github.com/YosysHQ/oss-cad-suite-build/releases/), [OpenFPGALoader](https://github.com/trabucayre/openFPGALoader).
2. Установить make, python: `sudo apt install make python3`
3. В директории Control выполнить `make upload`

### Тестирование
Для тестирования модуля в отрыве от остальных предусмотрен файл `top.sv`, позволяющий отследить выполнение основных команд через 4 кнопки и 4 светодиода на плате (key[3:0], led[3:0]).
Ниже представлена таблица команд для тестирования.

#### Таблица команд

| Код команды (key[3:0])| Код команды (command) | Управляющее воздействие |
|------------------------|----------------------|-------------------------|
| 0001                   | 7C83FF00             | Увеличить скорость мотора (motor_dc) |
| 0010                   | 6F90FF00             | Уменьшить скорость мотора (motor_dc) |
| 0011                   | 6A95FF00             | Передний ход (direction <= 1) |
| 0100                   | 659AFF00             | Задний ход (direction <= 0) |
| 0101                   | 649BFF00             | Увеличить значение сервопривода (servo_dc) |
| 0110                   | 6699FF00             | Уменьшить значение сервопривода (servo_dc) |
| 1000                   | 00000000             | Вернуть исходные значения сигналов (rst) |

#### Описание работы светодиодов

- **LED[0]**: Индикатор состояния (state):
  - Включен, если система включена (state = 1).
  - Выключен, если система выключена (state = 0).
  
- **LED[1]**: Индикатор направления (direction):
  - Включен, если направление установлено как "вперед" (direction = 1).
  - Выключен, если направление установлено как "назад" (direction = 0).

- **LED[2]**: Индикатор скорости мотора (motor_dc):
  - Включен, если скорость мотора больше 127 (motor_dc > 127).
  - Выключен, если скорость мотора меньше или равна 127.

- **LED[3]**: Индикатор положения сервопривода (servo_dc):
  - Включен, если значение сервопривода больше 155 (servo_dc > 155).
  - Выключен, если значение сервопривода меньше или равно 155.
